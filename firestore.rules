rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Users Collection Rules (FIX APPLIED) ---
    match /users/{userId} {
      // NEW RULE: This is the fix. It allows a newly authenticated user to CREATE
      // their own document, which is what happens during signup.
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.role in ['candidate', 'recruiter'];

      // This rule now correctly handles reading, updating, and deleting an EXISTING document.
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;


      // --- Recruiter-Specific Permissions (Unchanged but still needed) ---
      // Recruiters can READ any user profile for listing candidates.
      allow read: if request.auth != null
                  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter';

      // Recruiters can UPDATE a candidate's accountStatus.
      allow update: if request.auth != null
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter'
                    && resource.data.role == 'candidate'
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['accountStatus', 'updatedAt']);

      // Recruiters can DELETE a candidate's user document.
      allow delete: if request.auth != null
                     && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter'
                     && resource.data.role == 'candidate';
    }

    // --- Profiles Collection Rules (FIX APPLIED) ---
    // Added a create rule here as well for consistency and future-proofing.
    match /profiles/{userId} {
      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, write: if request.auth != null && request.auth.uid == userId;

      // Allow authenticated recruiters to READ any candidate's profile.
      allow read: if request.auth != null
                  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter';
    }

    // --- Jobs Collection Rules (Unchanged) ---
    match /jobs/{jobId} {
      // FIX: Allow anyone to read jobs, which is necessary for a public job board.
      // This resolves the issue where job lists appear empty.
      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.recruiterUID == request.auth.uid;
      allow update, delete: if request.auth != null
                             && resource.data.recruiterUID == request.auth.uid;
    }

    // --- Interviews Collection Rules (Unchanged) ---
    match /interviews/{interviewId} {
      allow create: if request.auth != null
                    && request.resource.data.candidateUID == request.auth.uid;

      allow read: if request.auth != null
                  && (
                       request.auth.uid == resource.data.candidateUID
                       ||
                       // Allow recruiters to view all interviews (Fixes list query permission issues)
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter'
                     );

      allow update: if request.auth != null
                    && exists(/databases/$(database)/documents/jobs/$(resource.data.jobId))
                    && get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.recruiterUID == request.auth.uid;
    }

    // --- Interview Requests Collection Rules (Unchanged) ---
    match /interviewRequests/{requestId} {
      allow create: if request.auth != null
                    && request.resource.data.candidateUID == request.auth.uid
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'candidate'
                    && get(/databases/$(database)/documents/jobs/$(request.resource.data.jobId)).data.recruiterUID == request.resource.data.recruiterUID;

      allow read: if request.auth != null
                  && (
                        request.auth.uid == resource.data.recruiterUID
                        ||
                        request.auth.uid == resource.data.candidateUID
                     );

      allow update: if request.auth != null
                    && request.auth.uid == resource.data.recruiterUID
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt']);
    }

    // --- Notifications Collection Rules (NEW) ---
    match /notifications/{notificationId} {
      // Candidates can read their own notifications
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      
      // Allow authenticated users (recruiters/system) to create notifications
      allow create: if request.auth != null;
      
      // Candidates can update (mark as read) their own notifications
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }
  }
}