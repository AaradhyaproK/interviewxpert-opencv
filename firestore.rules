rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // --- Users Collection Rules ---
    match /users/{userId} {
      // ADMIN PERMISSION: Allow admins to manage all users (read, create, update, delete)
      allow read, write: if request.auth != null 
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      // Existing: Allow new users to create their own document
      allow create: if request.auth != null
                    && request.auth.uid == userId
                    && request.resource.data.role in ['candidate', 'recruiter'];

      // Existing: Self management
      allow read, update, delete: if request.auth != null && request.auth.uid == userId;

      // Existing: Recruiter permissions
      allow read: if request.auth != null
                  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter';

      allow update: if request.auth != null
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter'
                    && resource.data.role == 'candidate'
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['accountStatus', 'updatedAt']);

      allow delete: if request.auth != null
                     && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter'
                     && resource.data.role == 'candidate';
    }

    // --- Recruiter Requests (New for Admin Dashboard) ---
    match /recruiterRequests/{requestId} {
      // Allow anyone to create a request (public signup)
      allow create: if true;
      
      // Only admins can read or modify requests
      allow read, write: if request.auth != null 
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';
    }

    // --- Profiles Collection Rules ---
    match /profiles/{userId} {
      // Admin Permission
      allow read, write: if request.auth != null 
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      allow create: if request.auth != null && request.auth.uid == userId;
      allow read, write: if request.auth != null && request.auth.uid == userId;

      allow read: if request.auth != null
                  && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter';
    }

    // --- Jobs Collection Rules ---
    match /jobs/{jobId} {
      // Admin Permission
      allow write: if request.auth != null 
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      allow read: if true;
      allow create: if request.auth != null
                    && request.resource.data.recruiterUID == request.auth.uid;
      allow update, delete: if request.auth != null
                             && resource.data.recruiterUID == request.auth.uid;
    }

    // --- Interviews Collection Rules ---
    match /interviews/{interviewId} {
      // Admin Permission
      allow read, write: if request.auth != null 
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      allow create: if request.auth != null
                    && request.resource.data.candidateUID == request.auth.uid;

      allow read: if request.auth != null
                  && (
                       request.auth.uid == resource.data.candidateUID
                       ||
                       get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'recruiter'
                     );

      allow update: if request.auth != null
                    && exists(/databases/$(database)/documents/jobs/$(resource.data.jobId))
                    && get(/databases/$(database)/documents/jobs/$(resource.data.jobId)).data.recruiterUID == request.auth.uid;
    }

    // --- Interview Requests Collection Rules ---
    match /interviewRequests/{requestId} {
      // Admin Permission
      allow read, write: if request.auth != null 
                          && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin';

      allow create: if request.auth != null
                    && request.resource.data.candidateUID == request.auth.uid
                    && get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'candidate'
                    && get(/databases/$(database)/documents/jobs/$(request.resource.data.jobId)).data.recruiterUID == request.resource.data.recruiterUID;

      allow read: if request.auth != null
                  && (
                        request.auth.uid == resource.data.recruiterUID
                        ||
                        request.auth.uid == resource.data.candidateUID
                     );

      allow update: if request.auth != null
                    && request.auth.uid == resource.data.recruiterUID
                    && request.resource.data.diff(resource.data).affectedKeys().hasOnly(['status', 'respondedAt', 'updatedAt']);
    }

    // --- Notifications Collection Rules ---
    match /notifications/{notificationId} {
      allow read: if request.auth != null && resource.data.userId == request.auth.uid;
      allow create: if request.auth != null;
      allow update: if request.auth != null && resource.data.userId == request.auth.uid;
    }

    // --- Transactions Collection Rules ---
    match /transactions/{transactionId} {
      // Allow authenticated users to create transaction records (e.g. after payment)
      allow create: if request.auth != null;
      
      // Admins can read all transactions. Users can read their own.
      allow read: if request.auth != null && (resource.data.userId == request.auth.uid || get(/databases/$(database)/documents/users/$(request.auth.uid)).data.role == 'admin');
    }
  }
}